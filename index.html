<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<link rel="apple-touch-icon" href="apple-touch-icon.png" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0f172a" />
<title>Momentum</title>
<style>
:root {
  --bg:#0f172a;
  --card:#1e293b;
  --border:#334155;
  --text:#f8fafc;
  --dim:#94a3b8;
  --accent:#10b981;
  --radius-lg:16px;
  --radius-md:12px;
  --pad-card:16px;
  --pad-screen:16px;
  --nav-h:70px;
  --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", Roboto, "Segoe UI", sans-serif;
}
*{box-sizing:border-box;-webkit-font-smoothing:antialiased;}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:var(--font-family);
}
.screen{
  padding:var(--pad-screen);
  padding-bottom:calc(var(--nav-h) + 40px);
  max-width:600px;
  margin:0 auto;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:var(--pad-card);
  margin-bottom:16px;
}
.card h2{
  margin:0 0 8px 0;
  font-size:16px;
  font-weight:600;
  color:var(--text);
  display:flex;
  align-items:center;
  flex-wrap:wrap;
  gap:.4rem;
}
.small{
  font-size:12px;
  color:var(--dim);
  line-height:1.4;
}
.row-between{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:6px;
  font-size:14px;
}
.row-left{
  color:var(--text);
  font-weight:600;
}
.row-right{
  color:var(--text);
  font-weight:600;
  text-align:right;
}
.progress-bg{
  background:#334155;
  border-radius:999px;
  height:10px;
  overflow:hidden;
  margin-top:12px;
}
.progress-fg{
  background:var(--accent);
  height:10px;
  width:0%;
}
.big-score{
  font-size:28px;
  font-weight:700;
  color:var(--accent);
  margin:4px 0;
}
.subtle{
  color:var(--dim);
  font-size:14px;
  font-weight:400;
}
.input-label{
  color:var(--dim);
  font-size:12px;
  margin-bottom:4px;
  display:block;
}
.input, textarea.input, select.input{
  width:100%;
  background:var(--bg);
  color:var(--text);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:10px 12px;
  font-size:16px;
  margin-bottom:12px;
  font-family:inherit;
}
textarea.input{
  min-height:80px;
  resize:none;
}
.btn-row{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:8px;
}
.btn{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:10px 16px;
  font-size:14px;
  color:var(--text);
  font-weight:500;
}
.btn.danger{
  color:#f87171;
  border-color:#f87171;
}
.list-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
  margin-bottom:8px;
  font-size:14px;
  color:var(--text);
  word-break:break-word;
}
.list-row .del{
  color:#f87171;
  font-size:14px;
  cursor:pointer;
  user-select:none;
}
.badge-num{
  font-weight:600;
  color:var(--accent);
}
.challenge-bar-bg{
  background:#334155;
  border-radius:999px;
  height:8px;
  overflow:hidden;
  margin-top:6px;
}
.challenge-bar-fg{
  background:var(--accent);
  height:8px;
  width:0%;
}
.flex-col{
  display:flex;
  flex-direction:column;
}
.nav{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  height:var(--nav-h);
  background:var(--card);
  border-top:1px solid var(--border);
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:999;
  font-size:12px;
}
.nav-btn{
  display:flex;
  flex-direction:column;
  align-items:center;
  color:var(--text);
  text-decoration:none;
  font-weight:500;
  background:none;
  border:0;
  padding:0;
  font-family:inherit;
}
.nav-btn.active{
  color:var(--accent);
}
.nav-emoji{
  font-size:20px;
  line-height:20px;
  margin-bottom:4px;
}
.hidden{display:none;}
#toast {
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:calc(var(--nav-h) + 16px);
  background:var(--accent);
  color:#0f172a;
  font-size:14px;
  font-weight:600;
  padding:10px 16px;
  border-radius:999px;
  opacity:0;
  transition:opacity .25s;
  z-index:1000;
}
#toast.show{opacity:1;}
</style>
</head>
<body>

<div id="toast">Saved</div>

<div id="screen-overview" class="screen"></div>
<div id="screen-health" class="screen hidden"></div>
<div id="screen-lifestyle" class="screen hidden"></div>
<div id="screen-workout" class="screen hidden"></div>
<div id="screen-motivation" class="screen hidden"></div>

<nav class="nav">
  <button class="nav-btn active" data-target="overview"><div class="nav-emoji">ğŸ</div>Overview</button>
  <button class="nav-btn" data-target="health"><div class="nav-emoji">â¤ï¸</div>Health</button>
  <button class="nav-btn" data-target="lifestyle"><div class="nav-emoji">ğŸŒ¿</div>Lifestyle</button>
  <button class="nav-btn" data-target="workout"><div class="nav-emoji">ğŸ‹ï¸</div>Workout</button>
  <button class="nav-btn" data-target="motivation"><div class="nav-emoji">ğŸ’«</div>Motivation</button>
</nav>

<script>
// helpers
function lsGet(key, fallback){try{const v=localStorage.getItem(key);return v?JSON.parse(v):fallback;}catch(e){return fallback;}}
function lsSet(key, val){localStorage.setItem(key, JSON.stringify(val));}
function todayISO(){return new Date().toISOString().slice(0,10);}

function weekStartISO(dateISO){
  const d = new Date((dateISO||todayISO())+"T00:00:00");
  const g = d.getDay();
  const diff = (g===0?-6:1)-g;
  d.setDate(d.getDate()+diff);
  d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}
function addDaysISO(dateISO, n){
  const d = new Date(dateISO+"T00:00:00");
  d.setDate(d.getDate()+n);
  return d.toISOString().slice(0,10);
}
function monthKey(dateISO){
  return (dateISO||todayISO()).slice(0,7); // YYYY-MM
}


function mondayOfThisWeekISO(){const d=new Date();const g=d.getDay();const diff=(g===0?-6:1)-g;d.setDate(d.getDate()+diff);d.setHours(0,0,0,0);return d.toISOString().slice(0,10);}
function uid(){return Math.random().toString(36).slice(2,10);}
function showToast(msg="Saved"){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1500);}

function escapeHtml(str){
  return (str||"").replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
}
function escapeAttr(str){ return escapeHtml(str); }

function minutesToPoints(min){
  const m = Number(min);
  if(!isFinite(m) || m < 15) return 0;
  return Math.floor(m/15);
}



function kmToMiles(km){ return (Number(km)||0) * 0.621371; }
function milesToKm(mi){ return (Number(mi)||0) * 1.60934; }
function fmtMiFromKm(km){
  const m = kmToMiles(km);
  return Math.round(m*10)/10;
}

function currentWeight(){
  if(!hLog.length) return null;
  return parseFloat(hLog[0].weight)||null;
}

function weightProgress(){
  if(weightStart==null || weightGoal==null) return null;
  const cw=currentWeight();
  if(cw==null) return null;
  const total = weightStart - weightGoal;
  if(total<=0) return null;
  const done = weightStart - cw;
  return Math.max(0, Math.min(100, Math.round((done/total)*100)));
}
function weightToGoal(){
  const cw=currentWeight();
  if(cw==null || weightGoal==null) return null;
  return Math.round((cw - weightGoal)*10)/10;
}

function weightLost(){
  if(weightStart==null) return null;
  const cw=currentWeight();
  if(cw==null) return null;
  return Math.round((weightStart - cw)*10)/10;
}


function compliment(){
  const msgs=["That counts.", "Quiet progress is still progress.", "You\u2019re building momentum.", "Small actions. Big direction.", "Proof > perfect.", "You showed up \u2014 that\u2019s the win.", "You\u2019re doing the work.", "This is how it changes."];
  return msgs[Math.floor(Math.random()*msgs.length)];
}
function maybeUnlock(key,label){
  if(unlocked[key]) return;
  unlocked[key]=true;
  recomputeSessionCounters();
    persist();
  showToast("ğŸ… Unlocked: "+label);
}



function toCSV(rows){
  if(!rows || !rows.length) return "";
  const esc = (v)=>{
    const s = (v===null || v===undefined) ? "" : String(v);
    if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  };
  return rows.map(r=>r.map(esc).join(",")).join("\n");
}
function downloadCSV(filename, rows){
  const csvText = toCSV(rows);
  const blob = new Blob([csvText], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}


// state
let entries=lsGet("workout_entries",[]);
let bpLog=lsGet("bp_log",[]);
let hLog=lsGet("h_log",[]);
let weightStart=lsGet("weight_start", null);
let weightGoal=lsGet("weight_goal", null);
let lwDays=lsGet("lw_days",{});
let lwEpoch=lsGet("lw_epoch",mondayOfThisWeekISO());
let focusWeek=lsGet("focus_week","Workout");
let reflections=lsGet("reflections",[]);
let motLog=lsGet("mot_log",[]);
let gratitudeLog=lsGet("gratitude_log",[]);
let journalLog=lsGet("journal_log",[]);
let weeklyMantra=lsGet("weekly_mantra","");
let checkins=lsGet("daily_checkins",[]);
let achievements=lsGet("achievements",[]);

let weekEpoch=lsGet("week_epoch_snapshot",mondayOfThisWeekISO());
let lastWeekSnapshot=lsGet("last_week_snapshot",{total:0,ts:mondayOfThisWeekISO()});
let goal=lsGet("weekly_goal",100);
let adaptiveGoals=lsGet("adaptive_goals",{strength:5,cardio:3,mobility:3});
let useAdaptive=true;
let firedFlags=lsGet("fired_flags",{});
let todaysWins=lsGet("todays_wins",{}); // {YYYY-MM-DD: true}
let moodLog=lsGet("mood_log",{}); // {YYYY-MM-DD: "ğŸ˜"}
let monthTheme=lsGet("month_theme","Consistency > Intensity");
let whyDoingThis=lsGet("why_doing_this","");
let lowEnergy=lsGet("low_energy",false);
let unlocked=lsGet("unlocked",{}); // {key:true}

let longTermProg=lsGet("longTermProg",{floors:0,totalKm:0,cyclingKm:0,rowingKm:0,reps:0,circuitEx:0, footKm:0});
// migrate older versions
if(longTermProg && typeof longTermProg==="object"){
  if(longTermProg.distanceKm!=null && longTermProg.totalKm==null){ longTermProg.totalKm = longTermProg.distanceKm; }
  if(longTermProg.totalKm==null) longTermProg.totalKm = 0;
  if(longTermProg.cyclingKm==null) longTermProg.cyclingKm = 0;
  if(longTermProg.rowingKm==null) longTermProg.rowingKm = 0;
  if(longTermProg.reps==null) longTermProg.reps = 0;
  if(longTermProg.circuitEx==null) longTermProg.circuitEx = 0;
}
let monthlyProg=lsGet("monthlyProg",{swings:0,cyclingKm:0,distanceKm:0,walkKm:0,yogaSessions:0,mobilitySessions:0,pushups:0,floors:0});
if(monthlyProg && typeof monthlyProg==="object"){ if(monthlyProg.distanceKm==null) monthlyProg.distanceKm=0; if(monthlyProg.walkKm==null) monthlyProg.walkKm=0; }

let weeklyProg=lsGet("weeklyProg",{strengthSessions:0,cardioSessions:0,distanceKm:0,rowingKm:0,reps:0,plankSec:0,mobilitySessions:0, footKm:0});
if(weeklyProg && typeof weeklyProg==="object"){ if(weeklyProg.rowingKm==null) weeklyProg.rowingKm=0; }

let weekendProg=lsGet("weekendProg",{swings:0,distanceKm:0,footKm:0,yogaSessions:0,reps:0,circuitEx:0,strengthSessions:0});
if(weekendProg && typeof weekendProg==="object"){ if(weekendProg.footKm==null) weekendProg.footKm=0; }


// rollover
function updateAdaptiveGoals(){
  adaptiveGoals = {
    strength: Math.max(3, adaptiveGoals.strength),
    cardio: Math.max(2, adaptiveGoals.cardio),
    mobility: Math.max(2, adaptiveGoals.mobility)
  };
  lsSet("adaptive_goals",adaptiveGoals);
}

function maybeRolloverWeek(){
  const currentMon=mondayOfThisWeekISO();
  if(currentMon!==weekEpoch){
    const snapshotTotal=calcWeekTotalPoints(weekEpoch);
    lastWeekSnapshot={total:snapshotTotal,ts:weekEpoch};
    weekEpoch=currentMon;
    persist();
  }
}
maybeRolloverWeek();
updateAdaptiveGoals();
recomputeSessionCounters();

// scoring
function calcStrengthDensity(entry){
  const reps = (parseFloat(entry.reps)||0) + (parseFloat(entry.pushups)||0) + (parseFloat(entry.swings)||0);
  const mins = parseFloat(entry.duration)||0;
  if(!reps || !mins) return null;
  return Math.round((reps / mins)*10)/10;
}


function uniqueDaysCount(filterFn){
  const s=new Set();
  (entries||[]).forEach(e=>{
    const d=(e.date||"").slice(0,10);
    if(!d) return;
    if(filterFn(e)) s.add(d);
  });
  return s.size;
}

// Recompute session-type counters so "sessions" mean "days" (1 per day)
function recomputeSessionCounters(){
  const isYoga = (e)=> (String(e.category||"").toLowerCase().match(/yoga|stretch/) );
  const isStrength = (e)=> (String(e.category||"").toLowerCase().match(/strength|kettlebell|kb|push|circuit/) );
  const isCardio = (e)=> (String(e.category||"").toLowerCase().match(/cardio|row|cycle|running|bike|stair|stairs|climb/) );

  // weekly
  if(typeof weeklyProg==="object" && weeklyProg){
    weeklyProg.strengthSessions = uniqueDaysCount(isStrength);
    weeklyProg.cardioSessions   = uniqueDaysCount(isCardio);
    weeklyProg.yogaSessions     = uniqueDaysCount(isYoga);
  }

  // monthly
  if(typeof monthlyProg==="object" && monthlyProg){
    // Keep yogaSessions as days too
    monthlyProg.yogaSessions = uniqueDaysCount(isYoga);
  }

  // weekend warrior: count days within current weekend bucket if youâ€™re using it as per-day too.
  // If weekendProg has yogaSessions, make it per-day within weekend by filtering dates in weekend range.
  if(typeof weekendProg==="object" && weekendProg){
    // Weekend definition: Sat+Sun of current week epoch (weekEpoch)
    const we = new Date(weekEpoch || mondayOfThisWeekISO());
    const sat = new Date(we); sat.setDate(sat.getDate()+5);
    const sun = new Date(we); sun.setDate(sun.getDate()+6);
    const satKey = sat.toISOString().slice(0,10);
    const sunKey = sun.toISOString().slice(0,10);
    const inWeekend = (e)=>{
      const d=(e.date||"").slice(0,10);
      return d===satKey || d===sunKey;
    };
    const weekendYogaDays = new Set();
    (entries||[]).forEach(e=>{
      const d=(e.date||"").slice(0,10);
      if(!d || !inWeekend(e)) return;
      if(isYoga(e)) weekendYogaDays.add(d);
    });
    weekendProg.yogaSessions = weekendYogaDays.size;
  }
}




function computeWorkoutPoints(weekStart){
  return entries.filter(e=>e.date>=weekStart).reduce((sum,e)=>{
    const mins=Number(e.duration)||0;
    const pts=minutesToPoints(mins);
    return sum+pts;
  },0);
}
function registerActivity(){ /* no-op: used by habit tracking */ }

function computeLifestylePoints(weekStart){
  // Lifestyle points are based on weekly consistency per habit:
  // 5/7 days = 5 pts, 7/7 days = 10 pts, otherwise 0.
  const s=new Date(weekStart);
  const habitKeys=new Set();
  Object.values(lwDays||{}).forEach(row=>{
    Object.keys(row||{}).forEach(k=>habitKeys.add(k));
  });

  let total=0;
  habitKeys.forEach(k=>{
    let c=0;
    for(let i=0;i<7;i++){
      const d=new Date(s); d.setDate(d.getDate()+i);
      const dk=d.toISOString().slice(0,10);
      if(lwDays?.[dk]?.[k]) c++;
    }
    if(c>=7) total += 10;
    else if(c>=5) total += 5;
  });
  return total;
}
function computeHealthPoints(weekStart){
  return bpLog.filter(r=>r.date>=weekStart).length;
}
function computeMotivationPoints(weekStart){
  return motLog.filter(m=>m.date>=weekStart).reduce((sum,m)=>sum+m.points,0);
}
function computeBonus(weekStart){
  let bonus=0;
  // habit streaks
  const habitKeys=new Set();
  Object.values(lwDays).forEach(row=>{
    Object.keys(row||{}).forEach(k=>habitKeys.add(k));
  });
  habitKeys.forEach(k=>{
    let c=0;
    const s=new Date(weekStart);
    for(let i=0;i<7;i++){
      const d=new Date(s); d.setDate(d.getDate()+i);
      const dk=d.toISOString().slice(0,10);
      if(lwDays?.[dk]?.[k]) c++;
    }
    if(c>=7) bonus+=5;
  });
  // 3+ workouts
  const workoutsThisWeek = entries.filter(e=>e.date>=weekStart).length;
  if(workoutsThisWeek>=3) bonus+=10;
  // BP victory
  const last3=bpLog.slice(0,3);
  if(last3.length===3){
    const avgS=Math.round(last3.reduce((s,x)=>s+(parseFloat(x.sys)||0),0)/3);
    const avgD=Math.round(last3.reduce((s,x)=>s+(parseFloat(x.dia)||0),0)/3);
    if(avgS<120 && avgD<80) bonus+=15;
  }
  return bonus;
}
function calcWeekComponents(weekStart){
  const workoutPts=computeWorkoutPoints(weekStart);
  const lifestylePts=computeLifestylePoints(weekStart);
  const healthPts=computeHealthPoints(weekStart);
  const motivationPts=computeMotivationPoints(weekStart);
  const bonusPts=computeBonus(weekStart);
  const total=workoutPts+lifestylePts+healthPts+motivationPts+bonusPts;
  return {workoutPts,lifestylePts,healthPts,motivationPts,bonusPts,total};
}
function calcWeekTotalPoints(weekStart){
  return calcWeekComponents(weekStart).total;
}

// persist
function persist(){
  lsSet("workout_entries",entries);
  lsSet("bp_log",bpLog);
  lsSet("h_log",hLog);
  lsSet("weight_start", weightStart);
  lsSet("weight_goal", weightGoal);
  lsSet("lw_days",lwDays);
  lsSet("lw_epoch",lwEpoch);
  lsSet("focus_week",focusWeek);
  lsSet("reflections",reflections);
  lsSet("mot_log",motLog);  lsSet("week_epoch_snapshot",weekEpoch);
  lsSet("last_week_snapshot",lastWeekSnapshot);
  lsSet("weekly_goal",goal);
  lsSet("fired_flags",firedFlags);
  lsSet("longTermProg",longTermProg);
  lsSet("monthlyProg",monthlyProg);
  lsSet("weeklyProg",weeklyProg);
  lsSet("weekendProg",weekendProg);
  lsSet("todays_wins",todaysWins);
  lsSet("mood_log",moodLog);
  lsSet("month_theme",monthTheme);
  lsSet("why_doing_this",whyDoingThis);
  lsSet("low_energy",lowEnergy);
  lsSet("unlocked",unlocked);
  // Motivation tab storage
  lsSet("gratitude_log", gratitudeLog);
  lsSet("journal_log", journalLog);
  lsSet("weekly_mantra", weeklyMantra);
  lsSet("daily_checkins", checkins);
  lsSet("achievements", achievements);

}

// reset helpers
function hardResetWeeklyScore(){
  const wk = weekEpoch;
  entries = entries.filter(e=>e.date < wk);
  motLog  = motLog.filter(e=>e.date < wk);
  lwDays = {};
  lwEpoch = mondayOfThisWeekISO();
  lastWeekSnapshot = {total:0, ts:weekEpoch};
  firedFlags[weekEpoch]=false;
  persist();
  showToast("Weekly score and lifestyle reset");
  renderOverview();
}
function resetLongTerm(){
  longTermProg={floors:0,distanceKm:0};
  persist(); showToast("Challenges reset"); renderWorkout();
}
function resetMonthly(){
  monthlyProg={swings:0,cyclingKm:0,yogaSessions:0};
  persist(); showToast("Challenges reset"); renderWorkout();
}
function resetWeeklyChal(){
  weeklyProg={strengthSessions:0,cardioSessions:0,floors:0};
  persist(); showToast("Challenges reset"); renderWorkout();
}
function resetWeekend(){
  weekendProg={swings:0,distanceKm:0,yogaSessions:0};
  persist(); showToast("Challenges reset"); renderWorkout();
}


// OVERVIEW
function renderOverview(){
  const wrap=document.getElementById("screen-overview");
  const {workoutPts,lifestylePts,healthPts,motivationPts,bonusPts,total:thisWeekTotal}=calcWeekComponents(weekEpoch);
  const lastWeekTotal=lastWeekSnapshot.total||0;
  const lastWeek = (lastWeekSnapshot && lastWeekSnapshot.ts) ? calcWeekComponents(lastWeekSnapshot.ts) : null;
  const diff=thisWeekTotal-lastWeekTotal;
  const pct=Math.min(100,Math.round((thisWeekTotal/(goal||1))*100));

  const t=todayISO();
  const winDone=!!todaysWins[t];
  const moods=["ğŸ˜","ğŸ˜","ğŸ™‚","ğŸ˜„","ğŸ”¥"];
  const start=new Date(weekEpoch);
  const weekStrip=[];
  for(let i=0;i<7;i++){
    const d=new Date(start); d.setDate(d.getDate()+i);
    const dk=d.toISOString().slice(0,10);
    weekStrip.push(moodLog[dk]||"â€¢");
  }

  const workoutsThisWeek = entries.filter(e=>e.date>=weekEpoch).length;
  const healthThisWeek = bpLog.filter(r=>r.date>=weekEpoch).length + hLog.filter(r=>r.date>=weekEpoch).length;
  const reflectionsThisWeek = reflections.filter(r=>r.date>=weekEpoch).length;
  const gratitudeThisWeek = (typeof gratitudeLog!=="undefined" ? gratitudeLog.filter(r=>r.date>=weekEpoch).length : 0);
  const journalThisWeek = (typeof journalLog!=="undefined" ? journalLog.filter(r=>r.date>=weekEpoch).length : 0);

  wrap.innerHTML=`
    <div class="card">
      <h2>âœ¨ Today</h2>
      <div class="row-between" style="align-items:center;">
        <div class="small" style="flex:1;">No pressure. One tiny action is enough.</div>
        <button class="btn" id="todaysWinBtn">${winDone?"Shown up âœ“":"I showed up today"}</button>
      </div>

      <div style="margin-top:12px;">
        <div class="small" style="margin-bottom:6px;">Mood check-in</div>
        <div class="btn-row" style="gap:6px;">
          ${moods.map(m=>`<button class="btn" data-mood="${m}" style="padding:8px 10px;min-width:44px;">${m}</button>`).join("")}
        </div>
        <div class="small" style="margin-top:10px;">This week: <span style="letter-spacing:.2rem;">${weekStrip.join(" ")}</span></div>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ Weekly Score <span class="subtle">(${weekEpoch} â†’ now)</span></h2>
      <div class="big-score">${thisWeekTotal} / ${goal} pts</div>
      <div class="small">
        Last week: ${lastWeekTotal} pts ${lastWeek ? ` â€¢ ğŸ‹ï¸ workouts ${lastWeek.workoutPts} pts` : ""}
        ${
          diff>0?` â€¢ â–² +${diff}`:
          diff<0?` â€¢ â–¼ ${diff}`:
          ` â€¢ same`
        }
      </div>
      ${lastWeek ? `<div class="small" style="margin-top:6px;opacity:.85;">Last week breakdown: ğŸ‹ï¸ ${lastWeek.workoutPts} â€¢ ğŸŒ¿ ${lastWeek.lifestylePts} â€¢ â¤ï¸ ${lastWeek.healthPts} â€¢ ğŸ’« ${lastWeek.motivationPts} â€¢ âœ¨ ${lastWeek.bonusPts} (bonus)</div>` : ""}
      <div class="progress-bg"><div class="progress-fg" style="width:${pct}%;"></div></div>
      <div class="small" style="margin-top:10px;">Theme: <span class="badge-num">${escapeHtml(monthTheme)}</span></div>
      <div class="btn-row" style="margin-top:12px;">
        <button class="btn" id="editThemeBtn">Edit theme</button>
        <button class="btn danger" id="resetWeeklyScoreBtn">Reset Weekly Score</button>
      </div>
      <div id="themeEdit" class="hidden" style="margin-top:10px;">
        <input class="input" id="themeInput" value="${escapeAttr(monthTheme)}" />
        <button class="btn" id="saveThemeBtn">Save</button>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“Š Breakdown</h2>
      <div class="row-between"><div>ğŸ‹ï¸ Workout</div><div>${workoutPts} pts</div></div>
      <div class="row-between"><div>ğŸŒ¿ Lifestyle</div><div>${lifestylePts} pts</div></div>
      <div class="row-between"><div>â¤ï¸ Health</div><div>${healthPts} pts</div></div>
      <div class="row-between"><div>ğŸ’« Motivation</div><div>${motivationPts} pts</div></div>
      <div class="row-between"><div>âœ¨ Bonus</div><div>${bonusPts} pts</div></div>
    </div>

    <div class="card">
      <h2>ğŸ¬ Weekly Highlight Reel</h2>
      <div class="small">Just the facts. You did more than you think.</div>
      <div class="list-row"><div style="flex:1;">ğŸ‹ï¸ Workouts logged</div><div class="badge-num">${workoutsThisWeek}</div></div>
      <div class="list-row"><div style="flex:1;">ğŸ©º Health entries</div><div class="badge-num">${healthThisWeek}</div></div>
      <div class="list-row"><div style="flex:1;">ğŸ™ Gratitude notes</div><div class="badge-num">${gratitudeThisWeek}</div></div>
      <div class="list-row"><div style="flex:1;">ğŸ“ Journal entries</div><div class="badge-num">${journalThisWeek}</div></div>
      <div class="list-row"><div style="flex:1;">ğŸŒ™ Reflections</div><div class="badge-num">${reflectionsThisWeek}</div></div>
    </div>

    <div class="card">
      <h2>ğŸ§­ Why Iâ€™m doing this</h2>
      <div class="small">One sentence. Your anchor.</div>
      <input class="input" id="whyInput" value="${escapeAttr(whyDoingThis)}" placeholder="Example: I want to feel strong and calm in my body.">
      <button class="btn" id="saveWhyBtn">Save</button>
    </div>
  `;

  wrap.querySelector("#resetWeeklyScoreBtn").onclick=()=>{hardResetWeeklyScore();};

  wrap.querySelector("#todaysWinBtn").onclick=()=>{
    todaysWins[t]=true;
    persist();
    showToast(compliment());
    renderOverview();
  };

  wrap.querySelectorAll("[data-mood]").forEach(b=>{
    b.onclick=()=>{
      moodLog[t]=b.getAttribute("data-mood");
      persist();
      showToast("Noted");
      renderOverview();
    };
  });

  const editBtn=wrap.querySelector("#editThemeBtn");
  const editBox=wrap.querySelector("#themeEdit");
  editBtn.onclick=()=>{ editBox.classList.toggle("hidden"); };
  wrap.querySelector("#saveThemeBtn").onclick=()=>{
    monthTheme = wrap.querySelector("#themeInput").value.trim() || monthTheme;
    persist();
    showToast("Saved");
    renderOverview();
  };

  wrap.querySelector("#saveWhyBtn").onclick=()=>{
    whyDoingThis = wrap.querySelector("#whyInput").value.trim();
    persist();
    showToast("Saved");
  };

  if(workoutsThisWeek>=3) maybeUnlock("three_workouts_week","3 workouts in a week");
  if(workoutsThisWeek>0 && healthThisWeek>0) maybeUnlock("health_and_workout_week","Health + Workout in one week");
}


// HEALTH (date pickers!)
function renderHealth(){
  const wrap=document.getElementById("screen-health");
  const last4H=hLog.slice(0,4);
  const last4BP=bpLog.slice(0,4);
  let avgBP="No BP data yet.";
  if(last4BP.length){
    const avgS=Math.round(last4BP.reduce((s,x)=>s+(parseFloat(x.sys)||0),0)/last4BP.length);
    const avgD=Math.round(last4BP.reduce((s,x)=>s+(parseFloat(x.dia)||0),0)/last4BP.length);
    avgBP=`Avg: ${avgS}/${avgD} mmHg`;
  }

  wrap.innerHTML=`
    
<div class="card">
  <h2>ğŸ¯ Weight Goal</h2>
  <label class="input-label">Starting weight (lb)</label>
  <input class="input" id="wsInput" inputmode="decimal" value="${weightStart??""}"/>
  <label class="input-label">Goal weight (lb)</label>
  <input class="input" id="wgInput" inputmode="decimal" value="${weightGoal??""}"/>
  <button class="btn" id="saveWeightGoalBtn">Save</button>

  <div class="row-between" style="margin-top:12px;">
    <div>Current</div>
    <div class="badge-num">${currentWeight()??"â€”"} lb</div>
  </div>
  
  <div class="row-between">
    <div>Lost</div>
    <div class="badge-num">${weightLost()??"â€”"} lb</div>
  </div>
  <div class="row-between">
    <div>To goal</div>
    <div class="badge-num">${weightToGoal()??"â€”"} lb</div>
  </div>

  <div style="margin-top:10px;">
    <div class="progress">
      <div class="progress-bar" style="width:${weightProgress()??0}%"></div>
    </div>
    <div class="small" style="opacity:.7;margin-top:4px;">
      ${weightProgress()??0}% to goal
    </div>
  </div>
</div>


<div class="card" id="health-weight-card">

      <h2>ğŸ©º Health â€” Weight & Body Comp</h2>
      <label class="input-label">Date</label>
      <input class="input" id="wDate" type="date" value="${todayISO()}"/>
      <label class="input-label">Weight (lb)</label>
      <input class="input" id="wWeight" inputmode="decimal"/>
       <label class="input-label">Lean Body Mass (lb)</label>
       <input class="input" id="wLBM" inputmode="decimal"/>
      <label class="input-label">Body Fat (%)</label>
      <input class="input" id="wFat" inputmode="decimal"/>
      <label class="input-label">Muscle (%)</label>
      <input class="input" id="wMuscle" inputmode="decimal"/>
      <button class="btn" id="saveHealth">ğŸ’¾ Save to Log</button>

      <div class="row-between" style="margin-top:16px;">
        <div class="row-left">ğŸ“Š Health Log (last 4)</div>
        <div class="row-right"><button class="btn" id="dlWeightCsvBtn">Download CSV</button></div>
      </div>
      ${
        last4H.length
        ? last4H.map(r=>`
          <div class="list-row">
            <div style="flex:1;">
               ${r.date} â€¢ ${r.weight||""}lb â€¢ ${r.lbm?("LBM "+r.lbm+"lb â€¢ "):""}${r.bodyfat||""}% â€¢ ${r.muscle||""}%
            </div>
            <div class="del" data-del-health="${r.id}">ğŸ—‘ï¸</div>
          </div>`).join("")
        : `<div class="small">No entries yet.</div>`
      }
    </div>

    <div class="card" id="health-bp-card">
      <h2>â¤ï¸ BP Log</h2>
      <label class="input-label">Date</label>
      <input class="input" id="bpDate" type="date" value="${todayISO()}"/>
      <label class="input-label">Systolic</label>
      <input class="input" id="bpSys" inputmode="decimal"/>
      <label class="input-label">Diastolic</label>
      <input class="input" id="bpDia" inputmode="decimal"/>
      <label class="input-label">On BP meds?</label>
      <select class="input" id="bpMeds">
        <option value="false">No</option>
        <option value="true">Yes</option>
      </select>
      <button class="btn" id="saveBP">ğŸ’¾ Save to Log</button>
      <div class="small" style="margin-top:8px;">${avgBP}</div>

      <div class="row-between" style="margin-top:16px;">
        <div class="row-left">ğŸ“Š BP Log (last 4)</div>
        <div class="row-right"><button class="btn" id="dlBpCsvBtn">Download CSV</button></div>
      </div>
      ${
        last4BP.length
        ? last4BP.map(r=>`
          <div class="list-row">
            <div style="flex:1;">
              ${r.date} â€¢ ${r.sys}/${r.dia} ${r.meds?"(meds)":""}
            </div>
            <div class="del" data-del-bp="${r.id}">ğŸ—‘ï¸</div>
          </div>`).join("")
        : `<div class="small">No BP data yet.</div>`
      }
    </div>
  `;

  
  const saveGoalBtn = wrap.querySelector("#saveWeightGoalBtn");
  if(saveGoalBtn){
    saveGoalBtn.onclick=()=>{
      const ws=parseFloat(wrap.querySelector("#wsInput").value);
      const wg=parseFloat(wrap.querySelector("#wgInput").value);
      if(!isNaN(ws)) weightStart=ws;
      if(!isNaN(wg)) weightGoal=wg;
      persist();
      showToast("Weight goal saved");
      renderHealth();
    };
  }

  wrap.querySelector("#saveHealth").onclick=()=>{

    const rec={
      id:uid(),
      date:wrap.querySelector("#wDate").value.trim(),
      weight:wrap.querySelector("#wWeight").value.trim(),
       lbm:wrap.querySelector("#wLBM").value.trim(),
      bodyfat:wrap.querySelector("#wFat").value.trim(),
      muscle:wrap.querySelector("#wMuscle").value.trim()
    };
    hLog=[rec,...hLog].slice(0,120);

    recomputeSessionCounters();
    persist();
    showToast(compliment());
    renderHealth();
  };

  wrap.querySelector("#saveBP").onclick=()=>{
    const rec={
      id:uid(),
      date:wrap.querySelector("#bpDate").value.trim(),
      sys:wrap.querySelector("#bpSys").value.trim(),
      dia:wrap.querySelector("#bpDia").value.trim(),
      meds:wrap.querySelector("#bpMeds").value==="true"
    };
    bpLog=[rec,...bpLog].slice(0,240);

    recomputeSessionCounters();
    persist();
    showToast(compliment());
    renderHealth();
  };

  wrap.querySelectorAll("[data-del-health]").forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.getAttribute("data-del-health");
      hLog=hLog.filter(x=>x.id!==id);
      persist();
      renderHealth();
    };
  });
  
  // Download CSVs
  const dlW = wrap.querySelector("#dlWeightCsvBtn");
  if(dlW){
    dlW.onclick=()=>{
      const rows = [["date","weight_lb","lean_body_mass_lb","body_fat_pct","muscle_pct"]]
        .concat((hLog||[]).slice().reverse().map(r=>[r.date||"", r.weight||"", r.lbm||"", r.bodyfat||"", r.muscle||""]));
      downloadCSV(`momentum_weight_log_${todayISO()}.csv`, rows);
    };
  }
  const dlB = wrap.querySelector("#dlBpCsvBtn");
  if(dlB){
    dlB.onclick=()=>{
      const rows = [["date","systolic","diastolic","on_meds"]]
        .concat((bpLog||[]).slice().reverse().map(r=>[r.date||"", r.sys||"", r.dia||"", r.meds ? "true":"false"]));
      downloadCSV(`momentum_bp_log_${todayISO()}.csv`, rows);
    };
  }

wrap.querySelectorAll("[data-del-bp]").forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.getAttribute("data-del-bp");
      bpLog=bpLog.filter(x=>x.id!==id);
      persist();
      renderHealth();
    };
  });
}

// LIFESTYLE (clean weekly grid + date picker)
function renderLifestyle(){
  const wrap=document.getElementById("screen-lifestyle");
  // habits (no alcohol/smoke)
  const HABITS=[
    {key:"sleep7",       label:"Sleep â‰¥7h ğŸ˜´"},
    {key:"steps",        label:"Steps â‰¥ 10,000 ğŸš¶"},
    {key:"outside",      label:"Outside time â‰¥ 30 min ğŸŒ³"},
    {key:"no_sugar",     label:"No added sugar ğŸ¬ğŸš«"},
    {key:"reading",      label:"Reading ğŸ“–"},
    {key:"declutter30",  label:"Declutter / cleaning â‰¥ 30 min ğŸ§¹"},
    {key:"mindbody",     label:"Meditation OR Yoga/Stretch ğŸ§˜"}
  ];

  function iso(d){ return d.toISOString().slice(0,10); }
  function parseISO(s){ const d=new Date(s+"T00:00:00"); d.setHours(0,0,0,0); return d; }
  function weekStartFromISO(s){
    const d=parseISO(s);
    const g=d.getDay();
    const diff=(g===0?-6:1)-g;
    d.setDate(d.getDate()+diff);
    return iso(d);
  }

  if(!lwEpoch) lwEpoch=mondayOfThisWeekISO();
  const selectedDate = lsGet("lifestyle_selected_date", todayISO());
  const weekStart = lwEpoch;

  function addDays(isoStr, n){
    const d=parseISO(isoStr); d.setDate(d.getDate()+n); return iso(d);
  }

  const days=[0,1,2,3,4,5,6].map(i=>addDays(weekStart,i));
  const dayLabels=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

  function getCell(dateISO, habitKey){
    return !!(lwDays?.[dateISO]?.[habitKey]);
  }
  function setCell(dateISO, habitKey, val){
    lwDays[dateISO]=lwDays[dateISO]||{};
    lwDays[dateISO][habitKey]=val;
  }

  function countHabitWeek(habitKey){
    return days.reduce((s,d)=>s+(getCell(d,habitKey)?1:0),0);
  }
  const totalPts = HABITS.reduce((s,h)=>s+countHabitWeek(h.key),0);
  const maxPts = HABITS.length * 7;
  const pct = Math.min(100, Math.round((totalPts/(maxPts||1))*100));

  wrap.innerHTML=`
    <div class="card">
      <h2>ğŸŒ¿ Weekly Lifestyle & Mini Challenges</h2>
      <div class="small">Week: ${weekStart} â†’ ${days[6]} â€¢ <span class="badge-num">${computeLifestylePoints(weekStart)}</span> pts â€¢ <span class="small" style="opacity:.85">${totalPts}/${maxPts} checks</span></div>
      <div class="progress-bg" style="margin-top:10px;"><div class="progress-fg" style="width:${pct}%;"></div></div>

      <div class="btn-row" style="margin-top:12px;">
        <button class="btn" id="prevWeekBtn">â†</button>
        <button class="btn" id="thisWeekBtn">This week</button>
        <button class="btn" id="nextWeekBtn">â†’</button>
        <button class="btn danger" id="resetWeekBtn">Reset week</button>
      </div>

      <div style="margin-top:14px;">
        <label class="input-label">Date</label>
        <input class="input" id="lifeDate" type="date" value="${selectedDate}"/>
        <div class="small" style="margin-top:-6px;">Tap a habit to toggle it for the selected date.</div>
      </div>
    </div>

    <div class="card">
      <h2>âœ… Habits</h2>
      ${HABITS.map(h=>{
        const done=countHabitWeek(h.key);
        const isOn=getCell(selectedDate,h.key);
        const p=Math.min(100, Math.round((done/7)*100));
        return `
          <div style="margin-bottom:14px;">
            <div class="row-between" style="align-items:center;">
              <div style="flex:1; font-size:14px;">${h.label}</div>
              <div class="small" style="margin-right:8px;">${done}/7</div>
              <label style="display:inline-flex;align-items:center;gap:8px;">
                <input type="checkbox" data-habit="${h.key}" ${isOn?"checked":""} style="transform:scale(1.2);"/>
              </label>
            </div>
            <div class="challenge-bar-bg"><div class="challenge-bar-fg" style="width:${p}%;"></div></div>
          </div>
        `;
      }).join("")}
      <div class="small">Consistency beats intensity. Even 1 check is momentum.</div>
    </div>

    <div class="card">
      <h2>ğŸ—“ This week at a glance</h2>
      <div class="small" style="margin-bottom:10px;">Checks per day</div>
      ${days.map((d,i)=>{
        const c=HABITS.reduce((s,h)=>s+(getCell(d,h.key)?1:0),0);
        return `<div class="list-row"><div style="flex:1;">${dayLabels[i]} â€¢ ${d}</div><div class="badge-num">${c}</div></div>`;
      }).join("")}
    </div>
  `;

  wrap.querySelector("#lifeDate").onchange=(ev)=>{
    const v=ev.target.value || todayISO();
    lsSet("lifestyle_selected_date", v);
    // snap week to selected date
    lwEpoch=weekStartFromISO(v);
    persist();
    renderLifestyle();
  };

  wrap.querySelectorAll('input[type="checkbox"][data-habit]').forEach(cb=>{
    cb.onchange=()=>{
      const key=cb.getAttribute("data-habit");
      setCell(selectedDate,key,cb.checked);
      registerActivity();
      persist();
      showToast(typeof compliment==="function" ? compliment() : "Saved");
      renderLifestyle();
    };
  });

  wrap.querySelector("#prevWeekBtn").onclick=()=>{
    const d=parseISO(lwEpoch); d.setDate(d.getDate()-7);
    lwEpoch=iso(d);
    persist(); renderLifestyle();
  };
  wrap.querySelector("#nextWeekBtn").onclick=()=>{
    const d=parseISO(lwEpoch); d.setDate(d.getDate()+7);
    lwEpoch=iso(d);
    persist(); renderLifestyle();
  };
  wrap.querySelector("#thisWeekBtn").onclick=()=>{
    lwEpoch=mondayOfThisWeekISO();
    persist(); renderLifestyle();
  };
  wrap.querySelector("#resetWeekBtn").onclick=()=>{
    days.forEach(d=>{ delete lwDays[d]; });
    persist();
    showToast("Week reset");
    renderLifestyle();
  };
}


// WORKOUT (date picker!)
function renderWorkout(){
  const wrap=document.getElementById("screen-workout");

  // --- Challenge counters computed from your workout log (for correct counting) ---
  function catLower(e){ return String(e.category||"").toLowerCase(); }
  function num(v){ const n=parseFloat(v); return isFinite(n)?n:0; }
  function entryMiles(e){
    // Use whichever the user entered; miles field is miles, km field is km.
    return num(e.miles) + kmToMiles(num(e.km));
  }
  function isStrengthCat(c){ return /(strength|kettlebell|kb|push|circuit)/.test(c); }
  function isCardioCat(c){ return /(cardio|rowing|row|cycling|cycle|bike|running|stairmaster|stair|stairs)/.test(c); }
  function isYogaCat(c){ return /(yoga|stretch)/.test(c); }
  function isWalkCat(c){ return /(walk)/.test(c); }
  function isRunCat(c){ return /(running)/.test(c); }
  function isRowCat(c){ return /(row)/.test(c); }
  function isCycleCat(c){ return /(cycling|cycle|bike)/.test(c); }
  function isStairCat(c){ return /(stairmaster|stair|stairs)/.test(c); }

  function inWeek(dateISO, weekStartISO){
    return dateISO>=weekStartISO && dateISO<addDaysISO(weekStartISO,7);
  }
  function currentMonthKey(){ return todayISO().slice(0,7); }
  function inMonth(dateISO, mk){ return (dateISO||"").slice(0,7)===mk; }

  // Weekend range: Sat + Sun of current weekEpoch
  const we = new Date((weekEpoch||mondayOfThisWeekISO())+"T00:00:00");
  const sat = new Date(we); sat.setDate(sat.getDate()+5); const satKey=sat.toISOString().slice(0,10);
  const sun = new Date(we); sun.setDate(sun.getDate()+6); const sunKey=sun.toISOString().slice(0,10);
  function inWeekend(dateISO){ return dateISO===satKey || dateISO===sunKey; }

  const mk = currentMonthKey();

  // --- LONG TERM ---
  let ltFloors=0, ltCycleMi=0, ltRowMi=0, ltTotalMi=0, ltCircuit=0;
  (entries||[]).forEach(e=>{
    const d=(e.date||"").slice(0,10); if(!d) return;
    const c=catLower(e);
    const mi=entryMiles(e);
    ltFloors += num(e.floors);
    ltCircuit += num(e.circuitEx);
    if(isCycleCat(c)) ltCycleMi += mi;
    if(isRowCat(c)) ltRowMi += mi;
    if(isCycleCat(c) || isRowCat(c) || isWalkCat(c) || isRunCat(c)) ltTotalMi += mi;
  });

  // --- MONTHLY ---
  let moSwings=0, moCycleMi=0, moWalkMi=0, moYogaSessions=0, moCircuit=0;
  (entries||[]).forEach(e=>{
    const d=(e.date||"").slice(0,10); if(!d || !inMonth(d,mk)) return;
    const c=catLower(e);
    const mi=entryMiles(e);
    moSwings += num(e.swings);
    moCircuit += num(e.circuitEx);
    if(isCycleCat(c)) moCycleMi += mi;
    if(isWalkCat(c))  moWalkMi  += mi;
    if(isYogaCat(c))  moYogaSessions += 1; // per yoga entry
  });

  // --- WEEKLY ---
  const strengthDays=new Set(), cardioDays=new Set(), yogaDays=new Set();
  let wkRunMi=0, wkRowMi=0, wkCircuit=0;
  (entries||[]).forEach(e=>{
    const d=(e.date||"").slice(0,10); if(!d || !inWeek(d,weekEpoch)) return;
    const c=catLower(e);
    const mi=entryMiles(e);
    wkCircuit += num(e.circuitEx);
    if(isStrengthCat(c)) strengthDays.add(d);
    if(isYogaCat(c)) yogaDays.add(d);
    if(isCardioCat(c)) cardioDays.add(d); // includes rowing/cycling/running/stairmaster
    if(isRunCat(c)) wkRunMi += mi;
    if(isRowCat(c)) wkRowMi += mi;
  });

  // --- WEEKEND ---
  const weekendYogaDays=new Set();
  let weRunMi=0, weAllMi=0, weCircuit=0, weStrengthOnSun=0;
  (entries||[]).forEach(e=>{
    const d=(e.date||"").slice(0,10); if(!d || !inWeekend(d)) return;
    const c=catLower(e);
    const mi=entryMiles(e);
    weCircuit += num(e.circuitEx);
    // Distance Dash includes cycling/rowing/walking/running
    if(isCycleCat(c) || isRowCat(c) || isWalkCat(c) || isRunCat(c)) weAllMi += mi;
    // Half marathon counts running only (per your spec)
    if(isRunCat(c)) weRunMi += mi;
    if(isYogaCat(c)) weekendYogaDays.add(d);
    if(d===sunKey && isStrengthCat(c)) weStrengthOnSun=1;
  });


  
  const longTermList=[
    {label:"ğŸ” Everest Base Camp (8,000 floors)", goal:8000, value:Math.min(8000, ltFloors)},
    {label:"ğŸš´ Emerald Rider (750 miles cycling)", goal:750, value:Math.min(750, Math.round(ltCycleMi*10)/10), unit:"mi"},
    {label:"ğŸš¶ Year of Movement (1,500 miles total)", goal:1500, value:Math.min(1500, Math.round(ltTotalMi*10)/10), unit:"mi"},
    {label:"ğŸš£ Steady Oars (500 miles rowing)", goal:500, value:Math.min(500, Math.round(ltRowMi*10)/10), unit:"mi"},
    {label:"ğŸ§© Circuit Foundation (10,000 circuit exercises)", goal:10000, value:Math.min(10000, Math.round(ltCircuit))}
  ];

  
  const monthList=[
    {label:"ğŸ’ª Swing Storm (1,000 KB swings)", goal:1000, value:Math.min(1000, Math.round(moSwings))},
    {label:"ğŸš´ Emerald Century (100 miles cycling)", goal:100, value:Math.min(100, Math.round(moCycleMi*10)/10), unit:"mi"},
    {label:"ğŸ›°ï¸ Zero-G Mobility (20 yoga sessions)", goal:20, value:Math.min(20, moYogaSessions)},
    {label:"ğŸš¶ Monthly Miles (90 miles walking)", goal:90, value:Math.min(90, Math.round(moWalkMi*10)/10), unit:"mi"}
  ];

  
  const weekList=[
    {label:"ğŸƒ Marathon (26.2 miles)", goal:26.2, value:Math.min(26.2, Math.round(wkRunMi*10)/10), unit:"mi"},
    {label:`ğŸ‹ï¸ Iron Week (${useAdaptive?adaptiveGoals.strength:5} strength workouts)`, goal:(useAdaptive?adaptiveGoals.strength:5), value:Math.min((useAdaptive?adaptiveGoals.strength:5), strengthDays.size)},
    {label:`ğŸƒ Cardio Crew (${useAdaptive?adaptiveGoals.cardio:3} sessions)`, goal:(useAdaptive?adaptiveGoals.cardio:3), value:Math.min((useAdaptive?adaptiveGoals.cardio:3), cardioDays.size)},
    {label:"ğŸš£ Engine Room (10 miles rowing)", goal:10, value:Math.min(10, Math.round(wkRowMi*10)/10), unit:"mi"},
    {label:`ğŸ§˜ Mobility Flow (${useAdaptive?adaptiveGoals.mobility:3} sessions)`, goal:(useAdaptive?adaptiveGoals.mobility:3), value:Math.min((useAdaptive?adaptiveGoals.mobility:3), yogaDays.size)}
  ];

  
  const weekendList=[
    {label:"ğŸ¥¾ On-Foot Half Marathon (13.1 miles)", goal:13.1, value:Math.min(13.1, Math.round(weRunMi*10)/10), unit:"mi"},
    {label:"ğŸ“ Distance Dash (40 miles)", goal:40, value:Math.min(40, Math.round(weAllMi*10)/10), unit:"mi"},
    {label:"ğŸ§˜ Recovery Ritual (2 sessions)", goal:2, value:Math.min(2, weekendYogaDays.size)},
    {label:"ğŸ Power Circuit (100 circuit exercises)", goal:100, value:Math.min(100, Math.round(weCircuit))},
    {label:"ğŸ”¥ Sunday Spark (1 strength session)", goal:1, value:Math.min(1, weStrengthOnSun)}
  ];


  function sectionChallenges(title,list,resetId){
    return `
    <div class="card">
      <h2>${title}</h2>
      ${list.map(item=>{
        const pct=Math.min(100,Math.round((item.value/(item.goal||1))*100));
        return `
          <div style="margin-bottom:16px;">
            <div class="row-between">
              <div class="row-left" style="font-weight:500;">${item.label}</div>
              <div class="row-right">${item.unit==="km" ? `${fmtMiFromKm(item.value)} / ${fmtMiFromKm(item.goal)} mi` : `${(item.unit==="mi") ? (Math.round(item.value*10)/10) : Math.round(item.value)} / ${item.goal}${item.unit==="mi" ? " mi":""}`}</div>
            </div>
            <div class="challenge-bar-bg">
              <div class="challenge-bar-fg" style="width:${pct}%;"></div>
            </div>
          </div>`;
      }).join("")}
      <div class="btn-row">
        <button class="btn danger" id="${resetId}">Reset Challenges</button>
      </div>
    </div>`;
  }

  const nowWeek = calcWeekComponents(weekEpoch);
  const pctWeek = Math.min(100,Math.round((nowWeek.total/(goal||1))*100));

  wrap.innerHTML=`
    <div class="card">
      <div class="row-between">
        <div class="row-left">This Week</div>
        <div class="row-right">${nowWeek.total}/${goal} pts</div>
      </div>
      <div class="progress-bg"><div class="progress-fg" style="width:${pctWeek}%;"></div></div>
      <div class="small">Includes bonus (${nowWeek.bonusPts} pts)</div>

      <div style="margin-top:12px;font-size:14px;color:var(--text);font-weight:600;">Weekly goal: ${goal}</div>
      <input class="input" id="goalInput" value="${goal}" inputmode="numeric" style="max-width:100px;">
    </div>

    
    <div class="card">
      <h2>ğŸ“ˆ Compare</h2>
      ${(()=>{
        const thisWeekKey = weekEpoch;
        const lastWeekKey = addDaysISO(thisWeekKey,-7);
        const prevWeekKey = addDaysISO(thisWeekKey,-14);

        const weekWorkoutPts = (wk)=> entries.filter(e=>e.date>=wk && e.date<addDaysISO(wk,7)).reduce((s,e)=>s+minutesToPoints(Number(e.duration)||0),0);

        const tw = weekWorkoutPts(thisWeekKey);
        const lw = weekWorkoutPts(lastWeekKey);
        const pw = weekWorkoutPts(prevWeekKey);

        // month compare (workout points)
        const thisMonth = monthKey(todayISO());
        const d0 = new Date(thisMonth+"-01T00:00:00");
        const lastMonthDate = new Date(d0); lastMonthDate.setMonth(lastMonthDate.getMonth()-1);
        const lastMonth = lastMonthDate.toISOString().slice(0,7);

        const monthWorkoutPts = (mk)=> entries.filter(e=>(e.date||"").slice(0,7)===mk).reduce((s,e)=>s+minutesToPoints(Number(e.duration)||0),0);

        const tm = monthWorkoutPts(thisMonth);
        const lm = monthWorkoutPts(lastMonth);

        // weekend compare (workout points) - Sat+Sun blocks by Saturday date
        function weekendKeyFromDate(dateISO){
          const d=new Date(dateISO+"T00:00:00");
          const g=d.getDay(); // 0 Sun .. 6 Sat
          const sat = new Date(d);
          sat.setDate(sat.getDate() + (6-g)); // move to Sat of that week
          sat.setHours(0,0,0,0);
          return sat.toISOString().slice(0,10); // Saturday
        }
        const weekendPtsByKey={};
        (entries||[]).forEach(e=>{
          const dk=(e.date||"").slice(0,10);
          if(!dk) return;
          const wd= new Date(dk+"T00:00:00").getDay();
          if(wd!==6 && wd!==0) return; // Sat or Sun
          const wk=weekendKeyFromDate(dk);
          weekendPtsByKey[wk]=(weekendPtsByKey[wk]||0)+minutesToPoints(Number(e.duration)||0);
        });
        const weekendKeys = Object.keys(weekendPtsByKey).sort().reverse();
        const w0 = weekendKeys[0] ? weekendPtsByKey[weekendKeys[0]] : 0;
        const w1 = weekendKeys[1] ? weekendPtsByKey[weekendKeys[1]] : 0;

        // records (workout points)
        const byWeek={};
        (entries||[]).forEach(e=>{
          const wk=weekStartISO((e.date||"").slice(0,10));
          byWeek[wk]=(byWeek[wk]||0)+minutesToPoints(Number(e.duration)||0);
        });
        let bestWeek={k:null,v:0};
        Object.entries(byWeek).forEach(([k,v])=>{ if(v>bestWeek.v){ bestWeek={k,v}; } });

        return `
          <div class="list-row"><div style="flex:1;">ğŸ‹ï¸ Workout points â€” this week</div><div class="badge-num">${tw}</div></div>
          <div class="list-row"><div style="flex:1;">Last week</div><div class="badge-num">${lw}</div></div>
          <div class="list-row"><div style="flex:1;">Week before</div><div class="badge-num">${pw}</div></div>
          <div class="list-row"><div style="flex:1;">Weekend (most recent)</div><div class="badge-num">${w0}</div></div>
          <div class="list-row"><div style="flex:1;">Weekend before</div><div class="badge-num">${w1}</div></div>
          <div class="list-row"><div style="flex:1;">This month</div><div class="badge-num">${tm}</div></div>
          <div class="list-row"><div style="flex:1;">Last month</div><div class="badge-num">${lm}</div></div>
          <div class="list-row"><div style="flex:1;">ğŸ† Record to beat (best workout week)</div><div class="badge-num">${bestWeek.v}${bestWeek.k?` <span class="small" style="opacity:.8;">(${bestWeek.k})</span>`:""}</div></div>
        `;
      })()}
    </div>


    <div class="card">
      <h2>â• Add Workout</h2>

      <label class="input-label">Date</label>
      <input class="input" id="wDate" type="date" value="${todayISO()}"/>

      <label class="input-label">Category</label>
      <select class="input" id="wCatSelect">
        <option value="Kettlebell">Kettlebell</option>
        <option value="Cardio">Cardio</option>
        <option value="Rowing">Rowing</option>
        <option value="Stairmaster">Stairmaster</option>
        <option value="Cycling">Cycling</option>
        <option value="Running">Running</option>
        <option value="Strength">Strength</option>
        <option value="Circuit">Circuit</option>
        <option value="Yoga">Yoga</option>        <option value="Walk">Walk</option>        <option value="Other">Otherâ€¦</option>
      </select>

      <div id="wCatOtherWrap" class="hidden">
        <label class="input-label">Custom category</label>
        <input class="input" id="wCatOther" placeholder="Type your category"/>
      </div>
<label class="input-label">Duration (min)</label>
      <input class="input" id="wDur" inputmode="numeric"/>

      <label class="input-label">Distance km</label>
      <input class="input" id="wKm" inputmode="decimal"/>

      <label class="input-label">Distance miles</label>
      <input class="input" id="wMiles" inputmode="decimal"/>

      <label class="input-label">Floors climbed</label>
      <input class="input" id="wFloors" inputmode="numeric"/>

      <label class="input-label">KB Swings</label>
      <input class="input" id="wSwings" inputmode="numeric"/>

      <label class="input-label">Plank sec</label>
      <input class="input" id="wPlank" inputmode="numeric"/>

      <label class="input-label">Push-ups</label>
      <input class="input" id="wPushups" inputmode="numeric"/>

      <label class="input-label">Total reps</label>
      <input class="input" id="wReps" inputmode="numeric"/>

      <label class="input-label">Circuit exercises</label>
      <input class="input" id="wCircuit" inputmode="numeric"/>


      <label class="input-label">Circuit exercises</label>
      <input class="input" id="wCircuitEx" inputmode="numeric"/>

      <label class="input-label">Notes</label>
      <textarea class="input" id="wNotes"></textarea>

      <button class="btn" id="addWorkoutBtn">Add Workout</button>
    </div>

    ${sectionChallenges("ğŸ” Long-Term Adventure Challenges", longTermList,"resetLongTermBtn")}
    ${sectionChallenges("ğŸ—“ Monthly Challenges", monthList,"resetMonthlyBtn")}
    ${sectionChallenges("ğŸ“… Weekly Challenges", weekList,"resetWeeklyChalBtn")}
    ${sectionChallenges("âš¡ Weekend Warrior", weekendList,"resetWeekendBtn")}

    <div class="card">
      <h2>Your Workouts</h2>
      ${
        entries.length===0
        ? '<div class="small">No workouts yet.</div>'
        : entries.map(e=>`
          <div class="list-row">
            <div style="flex:1;">
              <div style="font-weight:600;">${e.date} â€¢ ${e.category||""} <span class="badge-num" style="margin-left:8px;">${minutesToPoints(Number(e.duration)||0)} pts</span></div>
              <div class="small">
                ${e.duration?`â± ${e.duration} min `:""}
                ${e.km?`ğŸ“ ${e.km} km `:""}
                ${e.miles?`ğŸ›£ ${e.miles} mi `:""}
                ${e.floors?`ğŸ§— ${e.floors} floors `:""}
                ${e.swings?`ğŸ’ª ${e.swings} swings `:""}
                ${e.plank?`ğŸ§˜ ${e.plank} sec plank `:""}
                ${e.pushups?`ğŸ§± ${e.pushups} push-ups `:""}
                ${e.reps?`ğŸ” ${e.reps} reps `:""}${e.circuitEx?`ğŸ§© ${e.circuitEx} circuit ex `:""} ${calcStrengthDensity(e)?`âš¡ ${calcStrengthDensity(e)} reps/min`:""}
              </div>
              ${e.notes?`<div class="small">${e.notes}</div>`:""}
            </div>
            <div class="del" data-del-workout="${e.id}">ğŸ—‘ï¸</div>
          </div>
        `).join("")
      }
    </div>
  `;

  const catSel = wrap.querySelector("#wCatSelect");
  const catOtherWrap = wrap.querySelector("#wCatOtherWrap");
  if(catSel && catOtherWrap){
    catSel.onchange=()=>{
      if(catSel.value==="Other") catOtherWrap.classList.remove("hidden");
      else {
        catOtherWrap.classList.add("hidden");
        const other=wrap.querySelector("#wCatOther"); if(other) other.value="";
      }
    };
    catSel.onchange();
  }

  wrap.querySelector("#goalInput").onchange=(ev)=>{
    goal = Number(ev.target.value)||0;
    persist();
    showToast("Goal updated");
    renderWorkout();
  };

  wrap.querySelector("#addWorkoutBtn").onclick=()=>{
    const rec={
      id:uid(),
      date:wrap.querySelector("#wDate").value.trim(),
      category:(function(){
      const sel=wrap.querySelector("#wCatSelect");
      const val=(sel?sel.value:"").trim();
      if(val==="Other"){
        return (wrap.querySelector("#wCatOther")?.value||"").trim();
      }
      localStorage.last_cat = val; return val;
    })(),
      duration:wrap.querySelector("#wDur").value.trim(),
      km:wrap.querySelector("#wKm").value.trim(),
      miles:wrap.querySelector("#wMiles").value.trim(),
      floors:wrap.querySelector("#wFloors").value.trim(),
      swings:wrap.querySelector("#wSwings").value.trim(),
      plank:wrap.querySelector("#wPlank").value.trim(),
      pushups:wrap.querySelector("#wPushups").value.trim(),
      reps:wrap.querySelector("#wReps").value.trim(),
      circuitEx:wrap.querySelector("#wCircuitEx").value.trim(),
      notes:wrap.querySelector("#wNotes").value.trim()
    };
    entries=[rec,...entries];

    const kmVal = (parseFloat(rec.km)||0) + (parseFloat(rec.miles)||0)*1.60934;
    const floorsVal = parseFloat(rec.floors)||0;
    const swingsVal = parseFloat(rec.swings)||0;
    const repsVal = parseFloat(rec.reps)||0;
    const plankVal = parseFloat(rec.plank)||0;
    const circuitExVal = parseFloat(rec.circuitEx)||0;
    const pushupsVal = parseFloat(rec.pushups)||0;
    const cat = (rec.category||"").toLowerCase();
    const isYoga = cat.match(/yoga|stretch/);
    const isStrength = cat.match(/strength|kettlebell|kb|push/);
    const isCardio = cat.match(/cardio|row|cycle|running|bike|stair|stairs|climb/);

    // Challenge progress is computed from your log at render-time (no manual counter increments here).
    recomputeSessionCounters();
    persist();
    showToast(compliment());
    if((longTermProg.floors||0)>=1000) maybeUnlock("everest_1k_floors","1,000 floors climbed");
    if((monthlyProg.swings||0)>=1000) maybeUnlock("kb_1k_swings_month","1,000 KB swings (month)");
    renderWorkout();
  };

  wrap.querySelectorAll("[data-del-workout]").forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.getAttribute("data-del-workout");
      entries=entries.filter(x=>x.id!==id);
      persist();
      renderWorkout();
    };
  });

  wrap.querySelector("#resetLongTermBtn").onclick=()=>{ resetLongTerm(); };
  wrap.querySelector("#resetMonthlyBtn").onclick=()=>{ resetMonthly(); };
  wrap.querySelector("#resetWeeklyChalBtn").onclick=()=>{ resetWeeklyChal(); };
  wrap.querySelector("#resetWeekendBtn").onclick=()=>{ resetWeekend(); };
}

// MOTIVATION (segmented + less scroll)

function renderMotivation(){
  const wrap=document.getElementById("screen-motivation");
  if(!wrap) return;

  const recentCheckins  = (checkins||[]).slice(0,8);
  const recentGrat      = (gratitudeLog||[]).slice(0,8);
  const recentJournal   = (journalLog||[]).slice(0,6);
  const recentRef       = (reflections||[]).slice(0,6);

  wrap.innerHTML=`
    <div class="card" style="border:2px solid rgba(255,255,255,.15)">
      <h2>ğŸ—ºï¸ Weekly Mantra</h2>
      <div class="small" style="opacity:.8;margin-bottom:6px;">This weekâ€™s focus</div>
      <div style="font-size:1.1em;margin-bottom:10px;">
        ${weeklyMantra ? escapeHtml(weeklyMantra) : "<span style='opacity:.6'>No mantra set yet</span>"}
      </div>
      <input class="input" id="mantraInput" value="${escapeAttr(weeklyMantra||"")}" placeholder="Set your mantra for this week"/>
      <button class="btn primary" id="saveMantraBtn">Save Mantra</button>
    </div>

    

    <div class="card">
      <h2>âœ… Daily Check-In</h2>
      
      <div class="small" style="margin-bottom:6px;">Energy</div>
      <div class="btn-row" id="energyBtns" style="gap:6px;">
        ${["ğŸ˜´","ğŸ˜","ğŸ™‚","ğŸ˜„","âš¡"].map(e=>`<button class="btn" data-energy="${e}" style="padding:8px 10px;min-width:44px;">${e}</button>`).join("")}
      </div>

      <div class="small" style="margin:10px 0 6px;">Mood</div>
      <div class="btn-row" id="moodBtns" style="gap:6px;">
        ${["ğŸ˜","ğŸ˜","ğŸ™‚","ğŸ˜„","ğŸ”¥"].map(e=>`<button class="btn" data-mood="${e}" style="padding:8px 10px;min-width:44px;">${e}</button>`).join("")}
      </div>

      <input class="input" id="checkWin" placeholder="One-line win"/>
      <button class="btn primary" id="saveCheckinBtn">Save</button>
      ${recentCheckins.map(c=>`
        <div class="list-row">
          <div style="flex:1">
            <div class="small">${escapeHtml(c.date)}</div>
            <div>${escapeHtml(c.win)}</div>
          </div>
          <button class="btn danger" data-del-check="${c.id}">ğŸ—‘ï¸</button>
        </div>`).join("")}
    </div>

    <div class="card">
      <h2>ğŸ™ Gratitude</h2>
      <input class="input" id="gratText"/>
      <button class="btn primary" id="saveGratBtn">Save</button>
      ${recentGrat.map(g=>`
        <div class="list-row">
          <div style="flex:1">
            <div class="small">${escapeHtml(g.date)}</div>
            <div>${escapeHtml(g.text)}</div>
          </div>
          <button class="btn danger" data-del-grat="${g.id}">ğŸ—‘ï¸</button>
        </div>`).join("")}
    </div>

    <div class="card">
      <h2>ğŸ“ Journal</h2>
      <textarea class="input" id="journalText"></textarea>
      <button class="btn primary" id="saveJournalBtn">Save</button>
      ${recentJournal.map(j=>`
        <div class="list-row">
          <div style="flex:1">
            <div class="small">${escapeHtml(j.date)}</div>
            <div>${escapeHtml(j.text)}</div>
          </div>
          <button class="btn danger" data-del-journal="${j.id}">ğŸ—‘ï¸</button>
        </div>`).join("")}
    </div>

    <div class="card">
      <h2>ğŸª Weekly Reflection</h2>
      <textarea class="input" id="refText"></textarea>
      <button class="btn primary" id="saveRefBtn">Save</button>
      ${recentRef.map(r=>`
        <div class="list-row">
          <div style="flex:1">
            <div class="small">${escapeHtml(r.week||r.date)}</div>
            <div>${escapeHtml(r.text)}</div>
          </div>
          <button class="btn danger" data-del-ref="${r.id}">ğŸ—‘ï¸</button>
        </div>`).join("")}
    </div>
  `;

  wrap.querySelector("#saveMantraBtn").onclick=()=>{
    const v=(wrap.querySelector("#mantraInput")?.value||"").trim();
    weeklyMantra=v;
    persist();
    showToast("Weekly mantra saved");
    renderMotivation();
  };

  
  let selectedEnergy="";
  let selectedMood="";

  wrap.querySelectorAll("[data-energy]").forEach(b=>{
    b.onclick=()=>{
      selectedEnergy=b.getAttribute("data-energy");
      wrap.querySelectorAll("[data-energy]").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
    };
  });

  wrap.querySelectorAll("[data-mood]").forEach(b=>{
    b.onclick=()=>{
      selectedMood=b.getAttribute("data-mood");
      wrap.querySelectorAll("[data-mood]").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
    };
  });

  document.getElementById("saveCheckinBtn").onclick=()=>{
    const win=checkWin.value.trim(); if(!win) return;
    const energy = selectedEnergy || "";
    const mood = selectedMood || "";
    checkins=[{id:uid(),date:todayISO(),win,energy,mood,points:1},...checkins];
    motLog=[{id:uid(),date:todayISO(),type:"checkin",points:1},...motLog];
    persist(); renderMotivation();
  };

  document.getElementById("saveGratBtn").onclick=()=>{
    if(!gratText.value.trim()) return;
    gratitudeLog=[{id:uid(),date:todayISO(),text:gratText.value.trim(),points:1},...gratitudeLog];
    motLog=[{id:uid(),date:todayISO(),type:"gratitude",points:1},...motLog];
    persist(); renderMotivation();
  };

  document.getElementById("saveJournalBtn").onclick=()=>{
    if(!journalText.value.trim()) return;
    journalLog=[{id:uid(),date:todayISO(),text:journalText.value.trim(),points:1},...journalLog];
    motLog=[{id:uid(),date:todayISO(),type:"journal",points:1},...motLog];
    persist(); renderMotivation();
  };

  document.getElementById("saveRefBtn").onclick=()=>{
    if(!refText.value.trim()) return;
    reflections=[{id:uid(),week:mondayOfThisWeekISO(),text:refText.value.trim()},...reflections];
    persist(); renderMotivation();
  };

  wrap.querySelectorAll("[data-del-check]").forEach(b=>b.onclick=()=>{checkins=checkins.filter(x=>x.id!==b.dataset.delCheck);persist();renderMotivation();});
  wrap.querySelectorAll("[data-del-grat]").forEach(b=>b.onclick=()=>{gratitudeLog=gratitudeLog.filter(x=>x.id!==b.dataset.delGrat);persist();renderMotivation();});
  wrap.querySelectorAll("[data-del-journal]").forEach(b=>b.onclick=()=>{journalLog=journalLog.filter(x=>x.id!==b.dataset.delJournal);persist();renderMotivation();});
  wrap.querySelectorAll("[data-del-ref]").forEach(b=>b.onclick=()=>{reflections=reflections.filter(x=>x.id!==b.dataset.delRef);persist();renderMotivation();});
}
function showScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-'+name).classList.remove('hidden');
  document.querySelector('.nav-btn[data-target="'+name+'"]').classList.add('active');

  if(name==="overview") renderOverview();
  if(name==="health") renderHealth();
  if(name==="lifestyle") renderLifestyle();
  if(name==="workout") renderWorkout();
  if(name==="motivation") renderMotivation();
}
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    showScreen(btn.getAttribute('data-target'));
  });
});
showScreen("overview");

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./service-worker.js');
}
</script>
</body>
</html>
